<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Building a ESP8266 Weather Station with MQTT, HomeKit and WebInterface Part III | [self writeBlog];</title>
<meta name="keywords" content="esp8266, dht11, dht22">
<meta name="description" content="Part III
This is part III of a series of tutorials that build up on each other. If you missed the first parts, you can find it here: Part 1 Part 2
In this part we&rsquo;re going to use the esp8266 chip with the DHT11 sensor from part I to connect to our MQTT server from part II and publish the sensors data. Finally, we are going to build a iOS app to display our data.">
<meta name="author" content="Florian Harr">
<link rel="canonical" href="https://iflorian.com/esp8266-weather-station-part-3/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.a090830a421002426baafbd314e38f149d77b4c48a12ee9312700d770b27fb26.css" integrity="sha256-oJCDCkIQAkJrqvvTFOOPFJ13tMSKEu6TEnANdwsn&#43;yY=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://iflorian.com/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://iflorian.com/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://iflorian.com/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://iflorian.com/apple-touch-icon.png">
<link rel="mask-icon" href="https://iflorian.com/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://iflorian.com/esp8266-weather-station-part-3/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
<script>
  mermaid.initialize({ startOnLoad: true, theme: 'default' });
  mermaid.contentLoaded();
</script>
<meta property="og:url" content="https://iflorian.com/esp8266-weather-station-part-3/">
  <meta property="og:site_name" content="[self writeBlog];">
  <meta property="og:title" content="Building a ESP8266 Weather Station with MQTT, HomeKit and WebInterface Part III">
  <meta property="og:description" content="Part III This is part III of a series of tutorials that build up on each other. If you missed the first parts, you can find it here: Part 1 Part 2
In this part we’re going to use the esp8266 chip with the DHT11 sensor from part I to connect to our MQTT server from part II and publish the sensors data. Finally, we are going to build a iOS app to display our data.">
  <meta property="og:locale" content="en-us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="post">
    <meta property="article:published_time" content="2017-05-08T20:20:22-04:00">
    <meta property="article:modified_time" content="2017-05-08T20:20:22-04:00">
    <meta property="article:tag" content="Esp8266">
    <meta property="article:tag" content="Dht11">
    <meta property="article:tag" content="Dht22">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Building a ESP8266 Weather Station with MQTT, HomeKit and WebInterface Part III">
<meta name="twitter:description" content="Part III
This is part III of a series of tutorials that build up on each other. If you missed the first parts, you can find it here: Part 1 Part 2
In this part we&rsquo;re going to use the esp8266 chip with the DHT11 sensor from part I to connect to our MQTT server from part II and publish the sensors data. Finally, we are going to build a iOS app to display our data.">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://iflorian.com/post/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Building a ESP8266 Weather Station with MQTT, HomeKit and WebInterface Part III",
      "item": "https://iflorian.com/esp8266-weather-station-part-3/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Building a ESP8266 Weather Station with MQTT, HomeKit and WebInterface Part III",
  "name": "Building a ESP8266 Weather Station with MQTT, HomeKit and WebInterface Part III",
  "description": "Part III This is part III of a series of tutorials that build up on each other. If you missed the first parts, you can find it here: Part 1 Part 2\nIn this part we\u0026rsquo;re going to use the esp8266 chip with the DHT11 sensor from part I to connect to our MQTT server from part II and publish the sensors data. Finally, we are going to build a iOS app to display our data.\n",
  "keywords": [
    "esp8266", "dht11", "dht22"
  ],
  "articleBody": "Part III This is part III of a series of tutorials that build up on each other. If you missed the first parts, you can find it here: Part 1 Part 2\nIn this part we’re going to use the esp8266 chip with the DHT11 sensor from part I to connect to our MQTT server from part II and publish the sensors data. Finally, we are going to build a iOS app to display our data.\nThe first challenge we are going to solve is to connect our existing esp8266 + DHT11 weather station to our MQTT server. Given that we know the IP address of our server (that’s your local network address, in my case that’s 10.1.10.18) we can use a compatible C library, execute the connect method to connect to our server, subscribe to a topic and publish our data. The MQTT library that I’m going to use is going to be the “MQTT” library from the user 256dpi in the list. You can install it from within your Arduino IDE under Manage Libraries by searching for and installing MQTT by Joël Gähwiler/256dpi. Once you’ve done that, you can follow the code sample underneath:\n#include #include #include #include #define DHTTYPE DHT11 #define DHTPIN 14 #define WLAN_SSID \"YourWifiSSID\" #define WLAN_PASSWORD \"YourWifiPassword\" #define MQTT_SERVER_IP \"YourIPAddress\" #define TEMPERATURE_TOPIC \"weather/temperature\" #define HUMIDITY_TOPIC \"weather/humidity\" DHT dht(DHTPIN, DHTTYPE, 11); WiFiClient wifiClient; MQTTClient mqttClient; float temperature, humidity; unsigned long previousMillis = 0; const long interval = 30000; void connectMQTT() { mqttClient.begin(MQTT_SERVER_IP, 1883, wifiClient); if (mqttClient.connect(\"weatherStation\")) { Serial.println(\"Connected to MQTT broker\"); Serial.println(\"Subscribing to topic now\"); mqttClient.subscribe(\"weather/temperature\"); } } void setup() { Serial.begin(115200); delay(10); dht.begin(); Serial.println(); Serial.println(); Serial.print(\"Connecting to \"); Serial.println(WLAN_SSID); WiFi.mode(WIFI_STA); WiFi.begin(WLAN_SSID, WLAN_PASSWORD); while (WiFi.status() != WL_CONNECTED) { delay(500); Serial.print(\".\"); } Serial.println(); Serial.println(\"WiFi connected\"); Serial.println(\"IP address: \"); Serial.println(WiFi.localIP()); connectMQTT(); } void loop() { unsigned long currentMillis = millis(); if (currentMillis - previousMillis \u003e= interval) { previousMillis = currentMillis; humidity = dht.readHumidity(); temperature = dht.readTemperature(); if (isnan(humidity) || isnan(temperature)) { Serial.println(\"Failed to read from DHT sensor!\"); return; } mqttClient.publish(TEMPERATURE_TOPIC, String((int)temperature)); } if (!mqttClient.connected()) { connectMQTT(); } } void messageReceived(String topic, String payload, char * bytes, unsigned int length) { Serial.println(topic); Serial.println(payload); } So what did we code? Let’s focus on the methods. Compared to what we did in part I of this series, we’ve included the MQTTClient header file so we can use the MQTT library. This gives us the MQTTClient object that we can instantiate and then setup with it’s own begin() method. The begin method takes your MQTT’s server ip address and your esp8266 WiFiClient as arguments. After this initial setup, we can tell the MQTTClient to connect to the server and subscribe to a topic of our choosing on success of the connection. That is all that is needed for the setup, let’s look at the loop() method to see what we have to execute regularly to send data to our MQTT server.\nIn the loop function we have to read the sensor data from our DHT11 sensor. We do this only if our pre-set interval is over, to make sure we don’t do this too often eventually running into problems. Once we gathered the data, it is being send off to the server via the publish() method. That is all there is for the loop() function. Outside of that, we will have to add a interface function from our MQTTClient library. That’s the messageReceived() function that would be triggered if we would receive MQTT messages.\nPretty straight forward, isn’t it?\nIf you upload your updated sketch to your esp8266 now and your server is running, you should see data incoming now. To check the data you’re receiving, run mosquitto_sub -v -t 'weather/temperature' in a new terminal window on the same machine that is running your MQTT server.\nNext, we’re going to display our data in a small iOS app.\nCreate a new iOS project in Xcode, make it a Single View Application, preferably Objective-C as that’s what I’m going to use and save the project. Again, we’re going to use a MQTT library to make the connection. I’ve used this library in the past and it worked well. You can either add it via Carthage or CocoaPods, instructions on how to add the library to your project can be found on the libraries GitHub page. For simplicity reasons I use CocoaPods.\nOnce the library is installed and available within your project, drag two/four labels onto your view and connect the labels with your ViewController.\nAnd then add your code as follows in the implementation of your ViewController:\n#import \"ViewController.h\" #import @interface ViewController () \u003cMQTTSessionDelegate\u003e @property (weak, nonatomic) IBOutlet UILabel *tempValueLabel; @property (weak, nonatomic) IBOutlet UILabel *humidityValueLabel; @end @implementation ViewController - (void)viewDidLoad { [super viewDidLoad]; MQTTCFSocketTransport *transport = [[MQTTCFSocketTransport alloc] init]; transport.host = @\"192.168.178.20\"; transport.port = 1883; MQTTSession *session = [[MQTTSession alloc] init]; session.transport = transport; session.delegate = self; [session connectAndWaitTimeout:30]; [session subscribeToTopic:@\"weather/temperature\" atLevel:2 subscribeHandler:^(NSError *error, NSArray\u003cNSNumber *\u003e *gQoss){ if (error) { NSLog(@\"Subscription failed %@\", error.localizedDescription); } else { NSLog(@\"Subscription sucessfull! Granted Qos: %@\", gQoss); } }]; } - (void)newMessage:(MQTTSession *)session data:(NSData *)data onTopic:(NSString *)topic qos:(MQTTQosLevel)qos retained:(BOOL)retained mid:(unsigned int)mid { NSString *dataString = [[NSString alloc] initWithData:data encoding:NSUTF8StringEncoding]; NSLog(@\"%@\", topic); NSLog(@\"%@\", dataString); self.tempValueLabel.text = dataString; } @end Going through the important parts in the code from top to bottom:\nWe’ve added the MQTT library in our ViewController We initialize a transport socket and setup the variables we need to supply so we can connect to the correct server We set the delegate so we can receive MQTT messages from subscribed topics We subscribe to our topic (if you’re wondering about atLevel, you can set which QoS level you want to request) And at last we implement the delegate method that is called once we receive a new MQTT message on our MQTT topic that we subscribed to. Build and Run the project, wait until your esp8266 published new data and you should be able to see that your label gets updated.\nNow the last thing to do would be to integrate the temperature data. All we have to do here is add a few simple lines.\nOn the esp8266 project we only have to add this:\nmqttClient.publish(HUMIDITY_TOPIC, String((int)humidity)); For iOS we have to extend to our new topic:\n[session subscribeToTopic:@\"weather/humidity\" atLevel:2 subscribeHandler:^(NSError *error, NSArray *gQoss){}]; And update the label once we receive a message on that topic:\nif (topic == @\"weather/humidity\") { self.humidityValueLabel.text = dataString; } if (topic == @\"weather/temperature\") { self.tempValueLabel.text = dataString; } As you can see, MQTT is a simplistic protocol by design that is easy to use and implement. There are plenty of libraries for all common systems and technologies that will help you use your data across a variety of devices, but we are not fully done with the series yet. One thing that I really like about it in particular is the publisher/subscriber pattern where you don’t have to pull for data but you constantly receive updates!\nIn the last part we’re going to look at common use cases of MQTT in a connected home and how you can leverage it in your next project to make your home smarter. Stay tuned for the next episode!\n",
  "wordCount" : "1193",
  "inLanguage": "en",
  "datePublished": "2017-05-08T20:20:22-04:00",
  "dateModified": "2017-05-08T20:20:22-04:00",
  "author":{
    "@type": "Person",
    "name": "Florian Harr"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://iflorian.com/esp8266-weather-station-part-3/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "[self writeBlog];",
    "logo": {
      "@type": "ImageObject",
      "url": "https://iflorian.com/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://iflorian.com/" accesskey="h" title="[self writeBlog]; (Alt + H)">[self writeBlog];</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://iflorian.com/contact" title="Contact">
                    <span>Contact</span>
                </a>
            </li>
            <li>
                <a href="https://iflorian.com/about" title="About me">
                    <span>About me</span>
                </a>
            </li>
            <li>
                <a href="https://iflorian.com/euc" title="EUC">
                    <span>EUC</span>
                </a>
            </li>
            <li>
                <a href="https://iflorian.com/" title="My Blog">
                    <span>My Blog</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      Building a ESP8266 Weather Station with MQTT, HomeKit and WebInterface Part III
    </h1>
    <div class="post-meta"><span title='2017-05-08 20:20:22 -0400 -0400'>May 8, 2017</span>&nbsp;·&nbsp;<span>Florian Harr</span>

</div>
  </header> 
  <div class="post-content"><h1 id="part-iii">Part III<a hidden class="anchor" aria-hidden="true" href="#part-iii">#</a></h1>
<p>This is part III of a series of tutorials that build up on each other. If you missed the first parts, you can find it here: <a href="https://iflorian.com/esp8266-weather-station-part-1">Part 1</a> <a href="https://iflorian.com/esp8266-weather-station-part-2">Part 2</a></p>
<p>In this part we&rsquo;re going to use the esp8266 chip with the DHT11 sensor from part I to connect to our MQTT server from part II and publish the sensors data. Finally, we are going to build a iOS app to display our data.</p>
<p>The first challenge we are going to solve is to connect our existing esp8266 + DHT11 weather station to our MQTT server. Given that we know the IP address of our server (that&rsquo;s your local network address, in my case that&rsquo;s 10.1.10.18) we can use a compatible C library, execute the connect method to connect to our server, subscribe to a topic and publish our data. The MQTT library that I&rsquo;m going to use is going to be the &ldquo;MQTT&rdquo; library from the user 256dpi in the list. You can install it from within your Arduino IDE under <code>Manage Libraries</code> by searching for and installing MQTT by Joël Gähwiler/256dpi. Once you&rsquo;ve done that, you can follow the code sample underneath:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;MQTTClient.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;ArduinoJson.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;ESP8266WiFi.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;DHT.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define DHTTYPE   DHT11
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define DHTPIN    14
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define WLAN_SSID     &#34;YourWifiSSID&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define WLAN_PASSWORD &#34;YourWifiPassword&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define MQTT_SERVER_IP &#34;YourIPAddress&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define TEMPERATURE_TOPIC &#34;weather/temperature&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define HUMIDITY_TOPIC &#34;weather/humidity&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>DHT <span style="color:#a6e22e">dht</span>(DHTPIN, DHTTYPE, <span style="color:#ae81ff">11</span>);
</span></span><span style="display:flex;"><span>WiFiClient wifiClient;
</span></span><span style="display:flex;"><span>MQTTClient mqttClient;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">float</span> temperature, humidity;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> previousMillis <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> <span style="color:#66d9ef">long</span> interval <span style="color:#f92672">=</span> <span style="color:#ae81ff">30000</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">connectMQTT</span>() {
</span></span><span style="display:flex;"><span>  mqttClient.<span style="color:#a6e22e">begin</span>(MQTT_SERVER_IP, <span style="color:#ae81ff">1883</span>, wifiClient);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (mqttClient.<span style="color:#a6e22e">connect</span>(<span style="color:#e6db74">&#34;weatherStation&#34;</span>)) {
</span></span><span style="display:flex;"><span>    Serial.<span style="color:#a6e22e">println</span>(<span style="color:#e6db74">&#34;Connected to MQTT broker&#34;</span>);
</span></span><span style="display:flex;"><span>    Serial.<span style="color:#a6e22e">println</span>(<span style="color:#e6db74">&#34;Subscribing to topic now&#34;</span>);
</span></span><span style="display:flex;"><span>    mqttClient.<span style="color:#a6e22e">subscribe</span>(<span style="color:#e6db74">&#34;weather/temperature&#34;</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setup</span>() {
</span></span><span style="display:flex;"><span>        Serial.<span style="color:#a6e22e">begin</span>(<span style="color:#ae81ff">115200</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">delay</span>(<span style="color:#ae81ff">10</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        dht.<span style="color:#a6e22e">begin</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        Serial.<span style="color:#a6e22e">println</span>(); Serial.<span style="color:#a6e22e">println</span>();
</span></span><span style="display:flex;"><span>        Serial.<span style="color:#a6e22e">print</span>(<span style="color:#e6db74">&#34;Connecting to &#34;</span>);
</span></span><span style="display:flex;"><span>        Serial.<span style="color:#a6e22e">println</span>(WLAN_SSID);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        WiFi.<span style="color:#a6e22e">mode</span>(WIFI_STA);
</span></span><span style="display:flex;"><span>        WiFi.<span style="color:#a6e22e">begin</span>(WLAN_SSID, WLAN_PASSWORD);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span> (WiFi.<span style="color:#a6e22e">status</span>() <span style="color:#f92672">!=</span> WL_CONNECTED) {
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">delay</span>(<span style="color:#ae81ff">500</span>);
</span></span><span style="display:flex;"><span>                Serial.<span style="color:#a6e22e">print</span>(<span style="color:#e6db74">&#34;.&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        Serial.<span style="color:#a6e22e">println</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        Serial.<span style="color:#a6e22e">println</span>(<span style="color:#e6db74">&#34;WiFi connected&#34;</span>);
</span></span><span style="display:flex;"><span>        Serial.<span style="color:#a6e22e">println</span>(<span style="color:#e6db74">&#34;IP address: &#34;</span>); Serial.<span style="color:#a6e22e">println</span>(WiFi.<span style="color:#a6e22e">localIP</span>());
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">connectMQTT</span>();
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">loop</span>() {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> currentMillis <span style="color:#f92672">=</span> <span style="color:#a6e22e">millis</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (currentMillis <span style="color:#f92672">-</span> previousMillis <span style="color:#f92672">&gt;=</span> interval) {
</span></span><span style="display:flex;"><span>    previousMillis <span style="color:#f92672">=</span> currentMillis;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    humidity <span style="color:#f92672">=</span> dht.<span style="color:#a6e22e">readHumidity</span>();
</span></span><span style="display:flex;"><span>    temperature <span style="color:#f92672">=</span> dht.<span style="color:#a6e22e">readTemperature</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">isnan</span>(humidity) <span style="color:#f92672">||</span> <span style="color:#a6e22e">isnan</span>(temperature)) {
</span></span><span style="display:flex;"><span>      Serial.<span style="color:#a6e22e">println</span>(<span style="color:#e6db74">&#34;Failed to read from DHT sensor!&#34;</span>);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    mqttClient.<span style="color:#a6e22e">publish</span>(TEMPERATURE_TOPIC, <span style="color:#a6e22e">String</span>((<span style="color:#66d9ef">int</span>)temperature));
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>mqttClient.<span style="color:#a6e22e">connected</span>()) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">connectMQTT</span>();
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">messageReceived</span>(String topic, String payload, <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span> bytes, <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> length) {
</span></span><span style="display:flex;"><span>  Serial.<span style="color:#a6e22e">println</span>(topic);
</span></span><span style="display:flex;"><span>  Serial.<span style="color:#a6e22e">println</span>(payload);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>So what did we code? Let&rsquo;s focus on the methods.
Compared to what we did in part I of this series, we&rsquo;ve included the MQTTClient header file so we can use the MQTT library. This gives us the MQTTClient object that we can instantiate and then setup with it&rsquo;s own <code>begin()</code> method. The <code>begin</code> method takes your MQTT&rsquo;s server ip address and your esp8266 <code>WiFiClient</code> as arguments. After this initial setup, we can tell the MQTTClient to connect to the server and subscribe to a topic of our choosing on success of the connection. That is all that is needed for the setup, let&rsquo;s look at the loop() method to see what we have to execute regularly to send data to our MQTT server.<br>
In the loop function we have to read the sensor data from our DHT11 sensor. We do this only if our pre-set interval is over, to make sure we don&rsquo;t do this too often eventually running into problems. Once we gathered the data, it is being send off to the server via the <code>publish()</code> method. That is all there is for the <code>loop()</code> function. Outside of that, we will have to add a interface function from our MQTTClient library. That&rsquo;s the <code>messageReceived()</code> function that would be triggered if we would receive MQTT messages.</p>
<p>Pretty straight forward, isn&rsquo;t it?</p>
<p>If you upload your updated sketch to your esp8266 now and your server is running, you should see data incoming now. To check the data you&rsquo;re receiving, run <code>mosquitto_sub -v -t 'weather/temperature'</code> in a new terminal window on the same machine that is running your MQTT server.</p>
<p>Next, we&rsquo;re going to display our data in a small iOS app.</p>
<p>Create a new iOS project in Xcode, make it a <code>Single View Application</code>, preferably Objective-C as that&rsquo;s what I&rsquo;m going to  use and save the project. Again, we&rsquo;re going to use a MQTT library to make the connection. I&rsquo;ve used <a href="https://github.com/ckrey/MQTT-Client-Framework">this</a> library in the past and it worked well. You can either add it via Carthage or CocoaPods, instructions on how to add the library to your project can be found on the libraries <a href="https://github.com/ckrey/MQTT-Client-Framework">GitHub</a> page. For simplicity reasons I use CocoaPods.</p>
<p>Once the library is installed and available within your project, drag two/four labels onto your view and connect the labels with your ViewController.</p>
<p><img alt="Interface" loading="lazy" src="/images/2017/05/interface.png"></p>
<p>And then add your code as follows in the implementation of your ViewController:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#import &#34;ViewController.h&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#import &lt;MQTTClient/MQTTClient.h&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">@</span>interface <span style="color:#a6e22e">ViewController</span> () <span style="color:#f92672">&lt;</span>MQTTSessionDelegate<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">@</span><span style="color:#a6e22e">property</span> (weak, nonatomic) IBOutlet UILabel <span style="color:#f92672">*</span>tempValueLabel;
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">@</span><span style="color:#a6e22e">property</span> (weak, nonatomic) IBOutlet UILabel <span style="color:#f92672">*</span>humidityValueLabel;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">@</span>end
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">@</span>implementation ViewController
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">-</span> (<span style="color:#66d9ef">void</span>)viewDidLoad {
</span></span><span style="display:flex;"><span>    [super viewDidLoad];
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    MQTTCFSocketTransport <span style="color:#f92672">*</span>transport <span style="color:#f92672">=</span> [[MQTTCFSocketTransport alloc] init];
</span></span><span style="display:flex;"><span>    transport.host <span style="color:#f92672">=</span> <span style="color:#960050;background-color:#1e0010">@</span><span style="color:#e6db74">&#34;192.168.178.20&#34;</span>;
</span></span><span style="display:flex;"><span>    transport.port <span style="color:#f92672">=</span> <span style="color:#ae81ff">1883</span>;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    MQTTSession <span style="color:#f92672">*</span>session <span style="color:#f92672">=</span> [[MQTTSession alloc] init];
</span></span><span style="display:flex;"><span>    session.transport <span style="color:#f92672">=</span> transport;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    session.delegate <span style="color:#f92672">=</span> self;
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    [session connectAndWaitTimeout:<span style="color:#ae81ff">30</span>];
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    [session subscribeToTopic:<span style="color:#960050;background-color:#1e0010">@</span><span style="color:#e6db74">&#34;weather/temperature&#34;</span> atLevel:<span style="color:#ae81ff">2</span> subscribeHandler:<span style="color:#f92672">^</span>(NSError <span style="color:#f92672">*</span>error, NSArray<span style="color:#f92672">&lt;</span>NSNumber <span style="color:#f92672">*&gt;</span> <span style="color:#f92672">*</span>gQoss){
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (error) {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">NSLog</span>(<span style="color:#960050;background-color:#1e0010">@</span><span style="color:#e6db74">&#34;Subscription failed %@&#34;</span>, error.localizedDescription);
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">NSLog</span>(<span style="color:#960050;background-color:#1e0010">@</span><span style="color:#e6db74">&#34;Subscription sucessfull! Granted Qos: %@&#34;</span>, gQoss);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }];
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">-</span> (<span style="color:#66d9ef">void</span>)newMessage:(MQTTSession <span style="color:#f92672">*</span>)session
</span></span><span style="display:flex;"><span>              data:(NSData <span style="color:#f92672">*</span>)data
</span></span><span style="display:flex;"><span>           onTopic:(NSString <span style="color:#f92672">*</span>)topic
</span></span><span style="display:flex;"><span>               qos:(MQTTQosLevel)qos
</span></span><span style="display:flex;"><span>          retained:(BOOL)retained
</span></span><span style="display:flex;"><span>               mid:(<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>)mid {
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    NSString <span style="color:#f92672">*</span>dataString <span style="color:#f92672">=</span> [[NSString alloc] initWithData:data encoding:NSUTF8StringEncoding];
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">NSLog</span>(<span style="color:#960050;background-color:#1e0010">@</span><span style="color:#e6db74">&#34;%@&#34;</span>, topic);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">NSLog</span>(<span style="color:#960050;background-color:#1e0010">@</span><span style="color:#e6db74">&#34;%@&#34;</span>, dataString);
</span></span><span style="display:flex;"><span>    self.tempValueLabel.text <span style="color:#f92672">=</span> dataString;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">@</span>end
</span></span></code></pre></div><p>Going through the important parts in the code from top to bottom:</p>
<ul>
<li>We&rsquo;ve added the MQTT library in our ViewController</li>
<li>We initialize a transport socket and setup the variables we need to supply so we can connect to the correct server</li>
<li>We set the delegate so we can receive MQTT messages from subscribed topics</li>
<li>We subscribe to our topic (if you&rsquo;re wondering about atLevel, you can set which <a href="https://en.wikipedia.org/wiki/Quality_of_service">QoS</a> level you want to request)</li>
<li>And at last we implement the delegate method that is called once we receive a new MQTT message on our MQTT topic that we subscribed to.</li>
</ul>
<p>Build and Run the project, wait until your esp8266 published new data and you should be able to see that your label gets updated.</p>
<p>Now the last thing to do would be to integrate the temperature data. All we have to do here is add a few simple lines.</p>
<p>On the esp8266 project we only have to add this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>    mqttClient.<span style="color:#a6e22e">publish</span>(HUMIDITY_TOPIC, <span style="color:#a6e22e">String</span>((<span style="color:#66d9ef">int</span>)humidity));
</span></span></code></pre></div><p>For iOS we have to extend to our new topic:</p>
<pre tabindex="0"><code>    [session subscribeToTopic:@&#34;weather/humidity&#34; atLevel:2 subscribeHandler:^(NSError *error, NSArray&lt;NSNumber *&gt; *gQoss){}];
</code></pre><p>And update the label once we receive a message on that topic:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (topic <span style="color:#f92672">==</span> <span style="color:#960050;background-color:#1e0010">@</span><span style="color:#e6db74">&#34;weather/humidity&#34;</span>) {
</span></span><span style="display:flex;"><span>        self.humidityValueLabel.text <span style="color:#f92672">=</span> dataString;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (topic <span style="color:#f92672">==</span> <span style="color:#960050;background-color:#1e0010">@</span><span style="color:#e6db74">&#34;weather/temperature&#34;</span>) {
</span></span><span style="display:flex;"><span>        self.tempValueLabel.text <span style="color:#f92672">=</span> dataString;
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div><p>As you can see, MQTT is a simplistic protocol by design that is easy to use and implement. There are plenty of libraries for all common systems and technologies that will help you use your data across a variety of devices, but we are not fully done with the series yet. One thing that I really like about it in particular is the publisher/subscriber pattern where you don&rsquo;t have to pull for data but you constantly receive updates!</p>
<p>In the last part we&rsquo;re going to look at common use cases of MQTT in a connected home and how you can leverage it in your next project to make your home smarter. Stay tuned for the next episode!</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://iflorian.com/tags/esp8266/">Esp8266</a></li>
      <li><a href="https://iflorian.com/tags/dht11/">Dht11</a></li>
      <li><a href="https://iflorian.com/tags/dht22/">Dht22</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>All rights reserved - 2024</span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
